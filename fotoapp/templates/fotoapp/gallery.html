{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Galeria</title>
  <link rel="stylesheet" href="{% static 'css/gallery.css' %}" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet" />
</head>
<body>

  <header id="mainHeader">
    <div class="logo-left">
      <img src="{% static 'images/logo.png' %}" alt="Logo Kilar Fotografia" />
    </div>

    <div class="cart-header">
      <button type="button" id="open-mini-cart" class="cart-icon">
        üõí Koszyk (<span id="cart-count">{{ cart_count }}</span>)
      </button>
      {% if request.session.gallery_access %}
        <a href="{% url 'client_panel' %}" id="client-panel-btn" class="cart-icon" style="margin-left:8px;">
          üë§ Panel klienta
        </a>
      {% endif %}
    </div>
  </header>

  <main>
    <section class="gallery-grid">
      {% for photo in photos %}
        <div class="photo-item" data-photo-id="{{ photo.id }}">
          <div class="photo-select-bar">
            <button class="select-btn action-chip" type="button">
              <span class="icon">+</span>
              <span class="text">Wybierz</span>
            </button>
          </div>
          <a href="{% url 'serve_encrypted_image' photo.token %}" data-lightbox="session-gallery" class="no-middle-click">
            <img src="{% url 'serve_encrypted_image' photo.token %}" alt="Zdjƒôcie {{ photo.id }}" draggable="false" />
          </a>
          <div class="status-chip">Wybrano</div>
        </div>
      {% empty %}
        <p class="empty-gallery-message">Brak zdjƒôƒá w tej sesji.</p>
      {% endfor %}
    </section>
  </main>

  <!-- MINI-KOSZYK -->
  <div id="miniCartBackdrop" class="mc-backdrop"></div>
  <div id="miniCart" class="mc-panel">
    <div class="mc-header">
      Tw√≥j koszyk
      <button id="miniCartClose" class="mc-close" type="button">√ó</button>
    </div>
    <div class="mc-body" id="miniCartBody">
      <p style="text-align:center;color:#555">≈Åadowanie‚Ä¶</p>
    </div>
    <div class="mc-footer">
      <div>Suma: <strong><span id="miniCartTotal">0.00</span> z≈Ç</strong></div>
      <button id="checkoutBtn" class="mc-checkout" type="button">Przejd≈∫ do p≈Çatno≈õci</button>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 Kilar Fotografia. Wszelkie prawa zastrze≈ºone.</p>
  </footer>

  <!-- wymu≈õ ustawienie ciasteczka CSRF -->
  <form style="display:none">{% csrf_token %}</form>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
  <script>
    (function(){
      try {
        // --- CSRF cookie ---
        function getCookie(name){
          const value=("; "+document.cookie).split("; "+name+"=");
          if(value.length===2) return value.pop().split(";").shift();
        }
        const csrftoken = getCookie('csrftoken');

        // --- Referencje DOM ---
        const btnOpen = document.getElementById('open-mini-cart');
        const backdrop = document.getElementById('miniCartBackdrop');
        const panel = document.getElementById('miniCart');
        const btnClose = document.getElementById('miniCartClose');
        const bodyEl = document.getElementById('miniCartBody');
        const totalEl = document.getElementById('miniCartTotal');
        const headerCountEl = document.getElementById('cart-count');
        const galleryGrid = document.querySelector('.gallery-grid');

        function on(el, ev, fn){ if(el && el.addEventListener){ el.addEventListener(ev, fn); } }

        // Synchronizacja UI galerii z koszykiem
        function syncGalleryWithCart(idsSet){
          document.querySelectorAll('.photo-item').forEach(item=>{
            const id = item.dataset.photoId;
            const inCart = idsSet.has(String(id));
            const btn = item.querySelector('.select-btn');
            const icon = btn ? btn.querySelector('.icon') : null;
            const text = btn ? btn.querySelector('.text') : null;
            const chip = item.querySelector('.status-chip');

            item.classList.toggle('selected', inCart);
            if(icon) icon.textContent = inCart ? '-' : '+';
            if(text) text.textContent = inCart ? 'Usu≈Ñ' : 'Wybierz';
            if(chip) chip.classList.toggle('visible', inCart);
          });
        }

        // Otwieranie/zamykanie mini-koszyka
        function openMiniCart(){ backdrop.style.display='block'; panel.style.display='flex'; loadMiniCart(); }
        function closeMiniCart(){ backdrop.style.display='none'; panel.style.display='none'; }
        on(btnOpen, 'click', openMiniCart);
        on(backdrop, 'click', closeMiniCart);
        on(btnClose, 'click', closeMiniCart);

        // Usuwanie z mini-koszyka (delegacja)
        on(bodyEl, 'click', async (e)=>{
          const btn = e.target.closest('.mc-remove');
          if(!btn) return;
          const id = btn.dataset.id;
          try{
            const res = await fetch(`/api/cart/delete/${id}/`, { method:'POST', headers:{'X-CSRFToken': csrftoken} });
            if(!res.ok) throw new Error('HTTP '+res.status);
            const data = await res.json();
            await loadMiniCart();
            if(headerCountEl && typeof data.count!=='undefined'){ headerCountEl.textContent = data.count; }
          }catch(err){ console.error(err); alert('Nie uda≈Ço siƒô usunƒÖƒá pozycji z koszyka.'); }
        });

        // Wczytaj mini-koszyk
        async function loadMiniCart(){
          try{
            const res = await fetch('/api/cart/summary/');
            if(!res.ok) throw new Error('HTTP '+res.status);
            const data = await res.json();

            bodyEl.innerHTML='';

            if(!data.items || !data.items.length){
              bodyEl.innerHTML = '<p style="text-align:center;color:#777">Koszyk jest pusty.</p>';
              totalEl.textContent = '0.00';
              if(headerCountEl && typeof data.count!=='undefined'){ headerCountEl.textContent = data.count; }
              syncGalleryWithCart(new Set());
              return;
            }

            const idsInCart = new Set(data.items.map(i=>String(i.id)));
            for(const it of data.items){
              const row = document.createElement('div');
              row.className = 'mc-item';
              row.innerHTML = `
                <img src="${it.thumb}" alt="Zdjƒôcie ${it.id}" />
                <div class="mc-meta">
                  <div><strong>Zdjƒôcie #${it.id}</strong></div>
                  <div>Ilo≈õƒá: ${it.qty} √ó ${it.price} z≈Ç</div>
                </div>
                <div class="mc-right">
                  <div>${it.line_total} z≈Ç</div>
                  <button class="mc-remove" data-id="${it.id}" type="button">Usu≈Ñ</button>
                </div>
              `;
              bodyEl.appendChild(row);
            }
            totalEl.textContent = data.total || '0.00';
            if(headerCountEl && typeof data.count!=='undefined'){ headerCountEl.textContent = data.count; }

            // kluczowe: pe≈Çna synchronizacja galerii
            syncGalleryWithCart(idsInCart);

          }catch(err){
            console.error(err);
            bodyEl.innerHTML = '<p style="text-align:center;color:#777">Nie uda≈Ço siƒô pobraƒá koszyka.</p>';
            totalEl.textContent = '0.00';
          }
        }

        // ‚ÄûPrzejd≈∫ do p≈Çatno≈õci‚Äù ‚Äì placeholder
        on(document.getElementById('checkoutBtn'), 'click', ()=>{
          alert('Tutaj pod≈ÇƒÖczymy przekierowanie do Przelewy24 (checkout_start).');
        });

        // Zaznaczanie zdjƒôƒá (dodawanie/usuwanie)
        on(galleryGrid, 'click', async (e)=>{
          const btn = e.target.closest('.select-btn');
          if(!btn) return;
          const item = btn.closest('.photo-item');
          if(!item) return;
          const id = item.dataset.photoId;
          const icon = btn.querySelector('.icon');
          const text = btn.querySelector('.text');
          const chip = item.querySelector('.status-chip');

          const willSelect = !item.classList.contains('selected');
          // optymistycznie UI
          item.classList.toggle('selected', willSelect);
          if(icon) icon.textContent = willSelect ? '-' : '+';
          if(text) text.textContent = willSelect ? 'Usu≈Ñ' : 'Wybierz';
          if(chip) chip.classList.toggle('visible', willSelect);

          try{
            const url = willSelect ? `/api/cart/add/${id}/` : `/api/cart/delete/${id}/`;
            const res = await fetch(url, { method:'POST', headers:{'X-CSRFToken': csrftoken} });
            if(!res.ok) throw new Error('HTTP '+res.status);
            await loadMiniCart();
          }catch(err){
            console.error(err);
            // cofka UI
            const nowSel = item.classList.contains('selected');
            item.classList.toggle('selected', !nowSel);
            if(icon) icon.textContent = !nowSel ? '-' : '+';
            if(text) text.textContent = !nowSel ? 'Usu≈Ñ' : 'Wybierz';
            if(chip) chip.classList.toggle('visible', !nowSel);
            alert('Nie uda≈Ço siƒô zaktualizowaƒá koszyka.');
          }
        });

        // Lightbox + zabezpieczenia
        if (window.lightbox && lightbox.option) {
          lightbox.option({ resizeDuration: 100, wrapAround: true });
        }
        document.querySelectorAll('img').forEach(img=>{
          img.addEventListener('contextmenu', e=>e.preventDefault());
          img.setAttribute('draggable', 'false');
        });

      } catch (err) {
        console.error('B≈ÇƒÖd inicjalizacji skryptu galerii:', err);
      }
    })();
  </script>

</body>
</html>
