{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Galeria</title>
  <link rel="stylesheet" href="{% static 'css/gallery.css' %}">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css" rel="stylesheet" />
</head>
<body>

  <header id="mainHeader">
    <div class="logo-left">
      <img src="{% static 'images/logo.png' %}" alt="Logo Kilar Fotografia" /> {# Lepszy tekst alternatywny dla logo #}
    </div>
  </header>

  <main> {# Dodano element <main> dla lepszej semantyki #}
    <div class="gallery-controls"> {# Kontener dla zak≈Çadek i dropdownu #}
      <div class="gallery-tabs">
        <button class="gallery-tab active" data-filter="wszystkie">Wszystkie</button> {# Dodano atrybuty data dla filtrowania #}
        <button class="gallery-tab" data-filter="zaproponowane">Zaproponowane</button>
        <button class="gallery-tab" data-filter="do-pobrania">Do pobrania</button>
      </div>

      <div class="dropdown">
        <select id="photoFilterSelect"> {# Dodano ID dla ≈Çatwiejszego dostƒôpu w JS #}
          <option value="wszystkie">Wszystkie zdjƒôcia</option>
          <option value="wybrane">Wybrane</option>
          <option value="wydruki">Wydruki</option>
        </select>
      </div>
    </div>

    <section class="gallery-grid">
      {% for photo, encrypted in photos_data %}
        <div class="photo-item{% if photo.selected and not photo.print %} selected{% endif %}{% if photo.print %} print{% endif %}" data-photo-id="{{ photo.id }}">
          <div class="photo-select-bar">
            {% if photo.print %}
              <span class="print-label action-chip">üñ®Ô∏è Wydruki</span>
            {% elif photo.selected %}
              <button class="select-btn action-chip">
                <span class="icon">-</span>
                <span class="text">Usu≈Ñ</span>
              </button>
            {% else %}
              <button class="select-btn action-chip">
                <span class="icon">+</span>
                <span class="text">Wybierz</span>
              </button>
            {% endif %}
          </div>
          <a href="{% url 'serve_encrypted_image' encrypted.token %}" data-lightbox="session-gallery" class="no-middle-click">
            <img src="{% url 'serve_encrypted_image' encrypted.token %}" alt="Zdjƒôcie {{ photo.id }} z sesji" /> {# Lepszy tekst alternatywny #}
            <div class="photo-overlay">Do wyboru</div>
          </a>
          <div class="status-chip {% if photo.selected and not photo.print %}visible{% endif %}">Wybrano</div>
        </div>
      {% empty %}
        <p class="empty-gallery-message">Brak zdjƒôƒá w tej sesji.</p> {# Dodano klasƒô dla ewentualnego stylowania #}
      {% endfor %}
    </section>

    <div class="cart-actions"> {# Kontener dla przycisku koszyka #}
      <button id="add-to-cart">Dodaj do koszyka</button>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Kilar Fotografia. Wszelkie prawa zastrze≈ºone.</p> {# Poprawiono na paragraf dla sp√≥jno≈õci #}
  </footer>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Konfiguracja Lightbox ---
      lightbox.option({
        'resizeDuration': 100,
        'wrapAround': true,
      });

      // --- Obs≈Çuga zak≈Çadek galerii ---
      const galleryTabs = document.querySelectorAll('.gallery-tab');
      galleryTabs.forEach(tab => {
        tab.addEventListener('click', function() {
          galleryTabs.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          const filterValue = this.dataset.filter;
          // TODO: Implement filtering logic based on filterValue
          console.log('Filtruj wg:', filterValue);
        });
      });

      // --- Obs≈Çuga dropdownu filtrowania (je≈õli potrzebna dodatkowa logika) ---
      const photoFilterSelect = document.getElementById('photoFilterSelect');
      if (photoFilterSelect) {
        photoFilterSelect.addEventListener('change', function() {
          const selectedValue = this.value;
          // TODO: Implement filtering logic based on selectedValue
          console.log('Filtruj wg (select):', selectedValue);
        });
      }

      // --- Zaznaczanie zdjƒôƒá ---
      const galleryGrid = document.querySelector('.gallery-grid');
      if (galleryGrid) {
        galleryGrid.addEventListener('click', function(e) {
          const button = e.target.closest('.select-btn.action-chip');
          if (!button) return;

          const photoItem = button.closest('.photo-item');
          if (!photoItem || photoItem.classList.contains('print')) {
            return; // Nie r√≥b nic dla zdjƒôƒá 'print' lub je≈õli nie znaleziono photoItem
          }

          const iconElement = button.querySelector('.icon');
          const textElement = button.querySelector('.text');
          const statusChip = photoItem.querySelector('.status-chip');

          photoItem.classList.toggle('selected');

          if (photoItem.classList.contains('selected')) {
            if (iconElement) iconElement.textContent = '-';
            if (textElement) textElement.textContent = 'Usu≈Ñ';
            if (statusChip) statusChip.classList.add('visible');
          } else {
            if (iconElement) iconElement.textContent = '+';
            if (textElement) textElement.textContent = 'Wybierz';
            if (statusChip) statusChip.classList.remove('visible');
          }
          // Logika zmiany styl√≥w przycisk√≥w powinna byƒá obs≈Çugiwana przez CSS
          // np. .photo-item.selected .select-btn { ... }
          // np. .photo-item:not(.selected):not(.print) .select-btn { ... }
        });
      }

      // --- Inicjalizacja stanu dla element√≥w ju≈º zaznaczonych (obs≈Çugiwane przez Django Template) ---
      // Szablon Django powinien ju≈º poprawnie ustawiƒá klasy 'selected' i 'visible'
      // oraz tekst przycisk√≥w. Poni≈ºszy kod by≈Çby nadmiarowy, je≈õli Django
      // w pe≈Çni zarzƒÖdza stanem poczƒÖtkowym.
      /*
      document.querySelectorAll('.photo-item.selected:not(.print)').forEach(photoItem => {
        const button = photoItem.querySelector('.select-btn.action-chip');
        const iconElement = button.querySelector('.icon');
        const textElement = button.querySelector('.text');
        const statusChip = photoItem.querySelector('.status-chip');

        if (iconElement) iconElement.textContent = '-';
        if (textElement) textElement.textContent = 'Usu≈Ñ';
        if (statusChip) statusChip.classList.add('visible');
      });
      */

      // --- Ochrona obraz√≥w ---
      document.querySelectorAll('img').forEach(img => {
        img.addEventListener('contextmenu', e => e.preventDefault());
        img.setAttribute('draggable', 'false');
      });

      // Cykliczne zabezpieczanie obraz√≥w w Lightbox (je≈õli dynamicznie ≈Çadowane)
      // Rozwa≈º, czy to nadal potrzebne z aktualnƒÖ wersjƒÖ Lightbox2;
      // Lightbox mo≈ºe ju≈º wewnƒôtrznie obs≈Çugiwaƒá eventy na swoich obrazach.
      const protectLightboxImage = () => {
        const lightboxImg = document.querySelector('.lb-image');
        if (lightboxImg) {
          lightboxImg.oncontextmenu = () => false;
          lightboxImg.setAttribute('draggable', 'false');
        }
      };
      // Uruchom raz, a potem przy ka≈ºdej zmianie obrazu w lightboxie, je≈õli lightbox emituje zdarzenia.
      // Je≈õli nie, interwa≈Ç jest obej≈õciem.
      // Mo≈ºna by to zintegrowaƒá z eventami Lightboxa, np. po otwarciu nowego obrazu.
      protectLightboxImage(); // Wywo≈Çaj raz na poczƒÖtku
      new MutationObserver(protectLightboxImage).observe(document.body, { childList: true, subtree: true });
    


      //  blokowanie ≈õrodkowego przycisku myszy na linkach Lightbox
      document.querySelectorAll('.no-middle-click').forEach(link => {
        link.addEventListener('mousedown', function(e) {
          if (e.button === 1) { // 1 to ≈õrodkowy przycisk
            e.preventDefault();
          }
        });
        // auxclick jest bardziej standardowym eventem dla przycisk√≥w innych ni≈º lewy
        link.addEventListener('auxclick', function(e) {
          if (e.button === 1) {
            e.preventDefault();
          }
        });
      });

      // --- Dodawanie do koszyka ---
      const addToCartButton = document.getElementById('add-to-cart');
      if (addToCartButton) {
        addToCartButton.addEventListener('click', function() {
          const selectedPhotoIds = Array.from(document.querySelectorAll('.photo-item.selected'))
            .map(item => item.dataset.photoId);

          if (selectedPhotoIds.length > 0) {
            alert('Wybrane zdjƒôcia (ID): ' + selectedPhotoIds.join(', '));
            // Tutaj logika AJAX do wys≈Çania danych na serwer
            // np. fetch('/add-to-cart-url/', {
            //   method: 'POST',
            //   headers: {
            //     'Content-Type': 'application/json',
            //     'X-CSRFToken': '{{ csrf_token }}' // Je≈õli u≈ºywasz CSRF token√≥w Django
            //   },
            //   body: JSON.stringify({ photo_ids: selectedPhotoIds })
            // })
            // .then(response => response.json())
            // .then(data => console.log('Success:', data))
            // .catch((error) => console.error('Error:', error));
          } else {
            alert('Nie wybrano ≈ºadnych zdjƒôƒá.');
          }
        });
      }
    });
  </script>

</body>
</html>